<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de APIs de Geolocalizaci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>üß™ Test de APIs de Geolocalizaci√≥n</h1>
    
    <div class="test-section">
        <h3>1. Geolocalizaci√≥n por IP</h3>
        <button onclick="testIPLocation()">Probar APIs de IP</button>
        <div id="ip-result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Geolocalizaci√≥n GPS</h3>
        <button onclick="testGPSLocation()">Probar GPS</button>
        <div id="gps-result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Mapa Interactivo</h3>
        <button onclick="testMapLocation()">Abrir Mapa</button>
        <div id="map-result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Test Completo</h3>
        <button onclick="runCompleteTest()">Ejecutar Test Completo</button>
        <div id="complete-result"></div>
    </div>

    <script>
        // 1. Test de geolocalizaci√≥n por IP
        async function testIPLocation() {
            const resultDiv = document.getElementById('ip-result');
            resultDiv.innerHTML = '<p>üîÑ Probando APIs de IP...</p>';
            
            const apis = [
                { name: 'ipapi.co', url: 'https://ipapi.co/json/' },
                { name: 'ip-api.com', url: 'https://ip-api.com/json/' },
                { name: 'ipgeolocation.io', url: 'https://api.ipgeolocation.io/ipgeo?apiKey=free' }
            ];
            
            let successCount = 0;
            let results = [];
            
            for (const api of apis) {
                try {
                    console.log(`Probando ${api.name}...`);
                    const response = await fetch(api.url);
                    const data = await response.json();
                    
                    if (data.latitude && data.longitude) {
                        successCount++;
                        results.push({
                            name: api.name,
                            lat: data.latitude,
                            lng: data.longitude,
                            city: data.city || data.city_name || 'N/A',
                            country: data.country || data.country_name || 'N/A'
                        });
                    }
                } catch (error) {
                    console.error(`${api.name} fall√≥:`, error);
                }
            }
            
            if (successCount > 0) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <p>‚úÖ ${successCount}/${apis.length} APIs funcionando</p>
                        ${results.map(r => `
                            <p><strong>${r.name}:</strong> ${r.lat}, ${r.lng} (${r.city}, ${r.country})</p>
                        `).join('')}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<div class="error"><p>‚ùå Todas las APIs de IP fallaron</p></div>';
            }
        }
        
        // 2. Test de GPS
        async function testGPSLocation() {
            const resultDiv = document.getElementById('gps-result');
            resultDiv.innerHTML = '<p>üîÑ Probando GPS...</p>';
            
            if (!navigator.geolocation) {
                resultDiv.innerHTML = '<div class="error"><p>‚ùå Geolocalizaci√≥n no soportada</p></div>';
                return;
            }
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <p>‚úÖ GPS funcionando</p>
                        <p><strong>Latitud:</strong> ${position.coords.latitude}</p>
                        <p><strong>Longitud:</strong> ${position.coords.longitude}</p>
                        <p><strong>Precisi√≥n:</strong> ${Math.round(position.coords.accuracy)} metros</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <p>‚ùå GPS fall√≥: ${error.message}</p>
                        <p><strong>C√≥digo de error:</strong> ${error.code}</p>
                    </div>
                `;
            }
        }
        
        // 3. Test de mapa
        async function testMapLocation() {
            try {
                const result = await Swal.fire({
                    title: 'Seleccionar Ubicaci√≥n',
                    html: `
                        <div id="test-map" style="height: 400px; width: 100%;"></div>
                        <p class="mt-3">Haz clic en el mapa para seleccionar tu ubicaci√≥n</p>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Usar esta ubicaci√≥n',
                    cancelButtonText: 'Cancelar',
                    didOpen: () => {
                        const map = L.map('test-map').setView([19.4326, -99.1332], 13);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors'
                        }).addTo(map);
                        
                        let marker = null;
                        
                        map.on('click', (e) => {
                            if (marker) map.removeLayer(marker);
                            marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
                        });
                        
                        window.testMap = map;
                        window.testMarker = marker;
                    },
                    preConfirm: () => {
                        if (window.testMarker) {
                            const latlng = window.testMarker.getLatLng();
                            return { lat: latlng.lat, lng: latlng.lng };
                        }
                        return null;
                    }
                });
                
                if (result.isConfirmed && result.value) {
                    document.getElementById('map-result').innerHTML = `
                        <div class="success">
                            <p>‚úÖ Mapa funcionando</p>
                            <p><strong>Latitud:</strong> ${result.value.lat}</p>
                            <p><strong>Longitud:</strong> ${result.value.lng}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('map-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå Mapa fall√≥: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 4. Test completo
        async function runCompleteTest() {
            const resultDiv = document.getElementById('complete-result');
            resultDiv.innerHTML = '<p>üîÑ Ejecutando test completo...</p>';
            
            let results = {
                ip: false,
                gps: false,
                map: false
            };
            
            // Test IP
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                if (data.latitude && data.longitude) {
                    results.ip = true;
                }
            } catch (error) {
                console.error('IP test failed:', error);
            }
            
            // Test GPS
            if (navigator.geolocation) {
                try {
                    await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: false,
                            timeout: 5000,
                            maximumAge: 60000
                        });
                    });
                    results.gps = true;
                } catch (error) {
                    console.error('GPS test failed:', error);
                }
            }
            
            // Test Mapa (verificar si Leaflet est√° disponible)
            results.map = typeof L !== 'undefined';
            
            const successCount = Object.values(results).filter(Boolean).length;
            const totalTests = Object.keys(results).length;
            
            resultDiv.innerHTML = `
                <div class="${successCount === totalTests ? 'success' : 'info'}">
                    <p><strong>Resultado del Test Completo: ${successCount}/${totalTests}</strong></p>
                    <p>‚úÖ IP APIs: ${results.ip ? 'Funcionando' : 'Fallando'}</p>
                    <p>‚úÖ GPS: ${results.gps ? 'Funcionando' : 'Fallando'}</p>
                    <p>‚úÖ Mapa: ${results.map ? 'Disponible' : 'No disponible'}</p>
                    <p><strong>Recomendaci√≥n:</strong> ${successCount >= 2 ? 'Sistema listo para usar' : 'Revisar configuraci√≥n'}</p>
                </div>
            `;
        }
        
        // Auto-ejecutar test completo al cargar
        window.addEventListener('load', () => {
            setTimeout(runCompleteTest, 1000);
        });
    </script>
</body>
</html>
